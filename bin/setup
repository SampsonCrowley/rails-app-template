#!/usr/bin/env ruby
require 'fileutils'
include FileUtils

# path to your application root.
APP_ROOT = File.expand_path('..', __dir__)

def system!(*args)
  system(*args) || abort("\n== Command #{args} failed ==")
end

chdir APP_ROOT do
  # This script is a starting point to setup your application.
  # Add necessary setup steps to this file.
  recreate_db = false
  if ARGV[0]
    recreate_db = true
    puts "== Naming Application #{ARGV[0]} ==\n"
    nm = "#{ARGV[0]}"
    raise ArgumentError.new(:invalid_app_name) unless nm.length > 2 && (nm =~ /\A([A-Z][a-z]+)+/)
    class String
      def underscore
        self.gsub(/::/, '/').
        gsub(/([A-Z]+)([A-Z][a-z])/,'\1_\2').
        gsub(/([a-z\d])([A-Z])/,'\1_\2').
        tr("-", "_").
        downcase
      end
    end
    Dir.glob("#{APP_ROOT}/{config,test,client}/**/{.*,*}.{html*,js,json,jsx,rb,yml}").each do |file|
      unless File.directory?(file) || (file =~ /\.(br|g?z)(otli|ip)?$/)
        txt = File.read(file)
        txt = txt.gsub(/DefaultAppName/, nm).gsub(/default_app_name/, nm.underscore)
        File.open(file, 'w') {|f| f << txt}
      end
    end
    Dir.glob("#{APP_ROOT}/{config,test,client}/**/{.*,*}.base").each do |file|
      new_file = file.to_s.sub('.base', '')
      unless File.exist?(new_file)
        unless File.directory?(file)
          txt = File.read(file)
          txt = txt.gsub(/DefaultAppName/, nm).gsub(/default_app_name/, nm.underscore)
          File.open(new_file, 'w') {|f| f << txt}
        else
          File.rename(file, new_file)
        end
      end
    end
  end

  puts '== Installing dependencies =='
  system! 'gem install bundler --conservative'
  system('bundle check') || system!('bundle install')

  # puts "\n== Copying sample files =="
  # unless File.exist?('config/database.yml')
  #   cp 'config/database.yml.sample', 'config/database.yml'
  # end


  puts "\n== Preparing database =="
  if recreate_db
    system! 'bin/rails db:drop db:create db:migrate db:seed'
    system! 'cd client && yarn && cd ..'
  else
    system! 'bin/rails db:setup'
  end

  puts "\n== Removing old logs and tempfiles =="
  system! 'bin/rails log:clear tmp:clear'

  puts "\n== Restarting application server =="
  system! 'bin/rails restart'
end
